<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<title>Visualize Keycloak</title>

	<meta charset="utf-8" />
	<meta name="description" content="Sol Lewitt interactive project"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="keywords" content="HTML, Javascript, Visual Experience" />

	<!-- <link rel="stylesheet" href="assets/css/style.css"> -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
    <textarea style="width: 100%; resize: vertical; font-family:Verdana, Geneva, Tahoma, sans-serif; background-color: #f7f7f7; border-color: #f7f7f7; padding: 8px; box-sizing: border-box;" rows="10">
{
    "allowRemoteResourceManagement": true,
    "policyEnforcementMode": "ENFORCING",
    "resources": [
        {
        "name": "media-image",
        "ownerManagedAccess": false,
        "displayName": "MediaImage",
        "attributes": {},
        "_id": "6d05a80e-9605-4125-8190-57d04d4a7d5f",
        "uris": [],
        "scopes": [
            {
            "name": "kc_view"
            }
        ]
        },
        {
        "name": "kc_resource_1",
        "ownerManagedAccess": false,
        "displayName": "kc_resource_1",
        "attributes": {},
        "_id": "8c81ed2b-8f81-4bf3-a345-e1789a590ca6",
        "uris": [],
        "scopes": [
            {
            "name": "kc_create"
            },
            {
            "name": "kc_view"
            }
        ]
        },
        {
        "name": "Default Resource",
        "type": "urn:kc_auth:resources:default",
        "ownerManagedAccess": false,
        "attributes": {},
        "_id": "a87a4a2b-4bb2-4b7b-add7-57d448ac7b63",
        "uris": [
            "/*"
        ]
        }
    ],
    "policies": [
        {
        "id": "8a78bec7-b644-47e2-af48-49337cf02224",
        "name": "is_food_scout",
        "type": "role",
        "logic": "POSITIVE",
        "decisionStrategy": "UNANIMOUS",
        "config": {
            "roles": "[{\"id\":\"food-scouts\",\"required\":true}]"
        }
        },
        {
        "id": "0bc426aa-7feb-4474-be87-d5942a2447d9",
        "name": "kc_is_role",
        "type": "role",
        "logic": "POSITIVE",
        "decisionStrategy": "UNANIMOUS",
        "config": {
            "roles": "[{\"id\":\"kc_role_2\",\"required\":false},{\"id\":\"kc_role_1\",\"required\":true}]"
        }
        },
        {
        "id": "d7b7515e-f5cb-44b5-80f9-95108ec803f4",
        "name": "Default Policy",
        "description": "A policy that grants access only for users within this realm",
        "type": "js",
        "logic": "POSITIVE",
        "decisionStrategy": "AFFIRMATIVE",
        "config": {
            "code": "// by default, grants any permission associated with this policy\n$evaluation.grant();\n"
        }
        },
        {
        "id": "c6803e05-9fe1-4974-b678-214d9e8eefe8",
        "name": "view_images_permission",
        "type": "scope",
        "logic": "POSITIVE",
        "decisionStrategy": "UNANIMOUS",
        "config": {
            "resources": "[\"media-image\"]",
            "scopes": "[\"kc_view\"]",
            "applyPolicies": "[\"is_food_scout\"]"
        }
        },
        {
        "id": "19708d3a-184d-486a-961e-6d662453a54d",
        "name": "kc_permission_1",
        "type": "scope",
        "logic": "POSITIVE",
        "decisionStrategy": "UNANIMOUS",
        "config": {
            "resources": "[\"kc_resource_1\"]",
            "scopes": "[\"kc_create\"]",
            "applyPolicies": "[\"kc_is_role\"]"
        }
        },
        {
        "id": "8d11eb0d-dc3a-43c5-a0dc-95ba65f8711b",
        "name": "Default Permission",
        "description": "A permission that applies to the default resource type",
        "type": "resource",
        "logic": "POSITIVE",
        "decisionStrategy": "UNANIMOUS",
        "config": {
            "defaultResourceType": "urn:kc_auth:resources:default",
            "applyPolicies": "[\"Default Policy\"]"
        }
        }
    ],
    "scopes": [
        {
        "id": "b3882846-54d2-4ccf-a714-e9630d6fd564",
        "name": "kc_view"
        },
        {
        "id": "e283b2af-45f6-44fa-993e-5f9567c4eeb2",
        "name": "kc_create"
        }
    ],
    "decisionStrategy": "UNANIMOUS"
    }
    </textarea>
    <div class="canvas" style="display: flex; justify-content: center; align-items: center; min-height: 50vh;">
    </div>
    <script>
        const textarea = document.querySelector('textarea')
        const canvas = document.querySelector('div.canvas')

        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            themeVariables: {
                primaryColor: '#f7f7f7',
                secondaryColor: '#cddc39',
            }
        });

        const renderText = () => {
            const kc = JSON.parse(textarea.value)
            const lines = []

            const scopesIdLookUp = {}
            const resourcesIdLookUp = {}
            const policiesIdLookUp = {}
            const roles = []

            for (const {id, name} of kc.scopes) {
                scopesIdLookUp[name] = id
                lines.push(`${id}{{${name}}}`)
            }

            for (const {name, _id, scopes} of kc.resources) {
                resourcesIdLookUp[name]=_id
                lines.push(`${_id}[(${name})]`)
                
                for (const scope of scopes ?? []) {
                    lines.push(`${scopesIdLookUp[scope.name]} --> ${_id}`)
                }
            }

            for(const {id, name, config} of kc.policies.filter(x => x.type === "role")) {
                lines.push(`${id}([${name}])`)
                policiesIdLookUp[name]=id

                for(const {id: roleId, required} of JSON.parse(config.roles)) {
                    if(!roles.includes(roleId)) {
                        roles.push(roleId)
                        lines.push(`${roleId}(${roleId})`)
                    }
                    lines.push(`${roleId} ---> ${required ? '|.required.|' : ''} ${id}`)
                }
            }

            for(const {id, name, config} of kc.policies.filter(x => x.type === "scope")) {

                lines.push(`${id}[[${name}]]`)

                for(const resourceName of JSON.parse(config.resources)) {
                    lines.push(`${id} -.-> ${resourcesIdLookUp[resourceName]}`)
                }
                for(const scopeName of JSON.parse(config.scopes)) {
                    lines.push(`${id} --> ${scopesIdLookUp[scopeName]}`)
                }
                for(const policyName of JSON.parse(config.applyPolicies)) {
                    lines.push(`${policiesIdLookUp[policyName]} --> ${id}`)
                }
            }

            const mermaidContent = 'graph LR\n' + lines.map(x => "\t"+x).join("\n")
            
            mermaid.render(
                'Graph',
                mermaidContent,
                (svgCode) => canvas.innerHTML = svgCode
            );
        }

        renderText()
        textarea.addEventListener('input', renderText)
    </script>
</body>
</html>